name: Supabase CI

on:
  push:
    branches: [main, develop]
    paths:
      - 'supabase/**'
  pull_request:
    branches: [main, develop]
    paths:
      - 'supabase/**'

jobs:
  verify-migrations:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest
      
      - name: Start Supabase
        run: supabase start
      
      - name: Verify migrations
        run: |
          supabase db reset --db-url postgresql://postgres:postgres@127.0.0.1:54321/postgres
          supabase db lint
      
      - name: Run RLS policy check
        run: |
          supabase db execute --db-url postgresql://postgres:postgres@127.0.0.1:54321/postgres \
            --file - <<'EOF'
          select public.ensure_rls_enabled();
          EOF
      
      - name: Generate types
        run: |
          supabase gen types typescript --local > packages/config/supabase-types.ts
          if [ -n "$(git diff packages/config/supabase-types.ts)" ]; then
            echo "Generated types differ from committed types"
            git diff packages/config/supabase-types.ts
            exit 1
          fi
      
      - name: Stop Supabase
        run: supabase stop

  deploy-staging:
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    needs: verify-migrations
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest
      
      - name: Link to staging project
        run: |
          supabase link --project-ref ${{ secrets.STAGING_PROJECT_REF }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      
      - name: Push migrations
        run: supabase db push
      
      - name: Deploy Edge Functions
        run: |
          supabase functions deploy webhook-stripe
          supabase functions deploy webhook-twilio
          supabase functions deploy webhook-gvteway
          supabase functions deploy automation-triggers
          supabase functions deploy automation-actions
          supabase functions deploy health-check

  deploy-production:
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs: verify-migrations
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest
      
      - name: Link to production project
        run: |
          supabase link --project-ref ${{ secrets.PRODUCTION_PROJECT_REF }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      
      - name: Push migrations
        run: supabase db push
      
      - name: Deploy Edge Functions
        run: |
          supabase functions deploy webhook-stripe
          supabase functions deploy webhook-twilio
          supabase functions deploy webhook-gvteway
          supabase functions deploy automation-triggers
          supabase functions deploy automation-actions
          supabase functions deploy health-check
